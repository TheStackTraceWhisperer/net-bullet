name: CI

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      checks: write
      pull-requests: write

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up JDK 25
      uses: actions/setup-java@v4
      with:
        java-version: '25'
        distribution: 'temurin'
        cache: maven

    - name: Build and Test with Maven
      run: mvn -B clean verify

    - name: Publish Test Results
      uses: EnricoMi/publish-unit-test-result-action@v2
      if: always()
      with:
        files: |
          **/target/surefire-reports/*.xml
          **/target/failsafe-reports/*.xml

    - name: Upload Test Reports
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: test-reports
        path: |
          **/target/surefire-reports/
          **/target/failsafe-reports/
          
    - name: Upload Code Coverage Report
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: jacoco-report
        path: target/site/jacoco/
        
    - name: Upload Checkstyle Report
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: checkstyle-report
        path: target/checkstyle-result.xml
        
    - name: Upload PMD Report
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: pmd-report
        path: |
          target/pmd.xml
          target/cpd.xml
          
    - name: Upload SpotBugs Report
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: spotbugs-report
        path: target/spotbugsXml.xml
        
    - name: Comment Quality Summary on PR
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');
          let comment = '## üîç Quality Control Summary\n\n';
          
          // Add summary of quality checks
          comment += '### Checks Performed\n';
          comment += '- ‚úÖ Checkstyle: Code style enforcement\n';
          comment += '- ‚úÖ PMD: Code quality analysis\n';
          comment += '- ‚úÖ SpotBugs: Bug detection\n';
          comment += '- ‚úÖ JaCoCo: Code coverage measurement\n';
          comment += '- ‚úÖ Unit Tests: Functional correctness\n';
          comment += '- ‚úÖ Integration Tests: End-to-end validation\n\n';
          
          comment += '### üìä Reports Available\n';
          comment += 'Download artifacts from the Actions tab to view detailed reports:\n';
          comment += '- **Test Results**: Unit and integration test reports\n';
          comment += '- **Code Coverage**: JaCoCo coverage report\n';
          comment += '- **Checkstyle**: Code style violations\n';
          comment += '- **PMD**: Code quality issues\n';
          comment += '- **SpotBugs**: Potential bugs\n\n';
          
          comment += '### üìö Documentation\n';
          comment += 'See [QUALITY_METRICS.md](../blob/main/QUALITY_METRICS.md) for details on quality standards.\n';
          
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: comment
          });
